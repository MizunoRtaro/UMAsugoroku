<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”æˆ¸ç”ºåŒå…­ã‚²ãƒ¼ãƒ </title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
        #diceButton {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 18px;
        }
        #infoPanel {
            position: absolute;
            top: 50px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        #infoPanel button {
            margin: 5px;
            padding: 5px 10px;
        }
        #audioControls {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        #audioControls button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="info">äº”æˆ¸ç”ºåŒå…­ã‚²ãƒ¼ãƒ </div>
    <button id="diceButton">ã‚µã‚¤ã‚³ãƒ­ã‚’ã‚‹</button>
    <div id="audioControls">
        <button id="bgmButton">ğŸµ BGMã‚ªãƒ³</button>
        <button id="sfxButton">ğŸ”Š åŠ¹æœéŸ³ã‚ªãƒ³</button>
    </div>
    <div id="infoPanel"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 5); // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®èƒŒå¾Œã«é…ç½®
        camera.lookAt(0, 0, 0);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // ãƒ©ã‚¤ãƒˆã®è¿½åŠ 
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½œæˆ
        const fieldGeometry = new THREE.PlaneGeometry(60, 60);
        const fieldMaterial = new THREE.MeshStandardMaterial({ color: 0x90EE90 });
        const field = new THREE.Mesh(fieldGeometry, fieldMaterial);
        field.rotation.x = -Math.PI / 2;
        scene.add(field);

        // ãƒã‚¹ç›®ã®ä½œæˆ
        const squares = [];
        for (let i = 0; i < 9; i++) {
            const squareGeometry = new THREE.BoxGeometry(5, 0.1, 5);
            const squareMaterial = new THREE.MeshStandardMaterial({ color: 0xFFFFFF });
            const square = new THREE.Mesh(squareGeometry, squareMaterial);
            square.position.set(-25 + i * 6, 0.05, -25);
            scene.add(square);
            squares.push(square);
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®åˆæœŸä½ç½®
        const startPosition = new THREE.Vector3(-25, 0.5, -25);

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¨­å®š
        let character;
        let waitingModel, runningModel;
        let waitingMixer, runningMixer;
        let waitingAction, runningAction;
        const loader = new THREE.GLTFLoader();

        loader.load('å¾…æ©Ÿã†ã¾.glb', (gltf) => {
            waitingModel = gltf.scene;
            waitingModel.scale.set(1.2, 1.2, 1.2); // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’1.5ã‹ã‚‰1.2ã«ç¸®å°
            waitingModel.position.copy(startPosition);
            character = waitingModel;
            scene.add(character);

            waitingMixer = new THREE.AnimationMixer(waitingModel);
            const waitingClip = gltf.animations[0];
            waitingAction = waitingMixer.clipAction(waitingClip);
            waitingAction.play();
        });

        loader.load('èµ°ã‚‹ã‚¦ãƒ.glb', (gltf) => {
            runningModel = gltf.scene;
            runningModel.scale.set(1.2, 1.2, 1.2); // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’1.5ã‹ã‚‰1.2ã«ç¸®å°
            runningModel.visible = false;
            scene.add(runningModel);

            runningMixer = new THREE.AnimationMixer(runningModel);
            const runningClip = gltf.animations[0];
            runningAction = runningMixer.clipAction(runningClip);
        });

        // ã‚µã‚¤ã‚³ãƒ­ã®ä½œæˆ
        const diceGeometry = new THREE.BoxGeometry(2, 2, 2);
        const diceMaterials = [
            new THREE.MeshStandardMaterial({ color: 0xFFFFFF }),
            new THREE.MeshStandardMaterial({ color: 0xFFFFFF }),
            new THREE.MeshStandardMaterial({ color: 0xFFFFFF }),
            new THREE.MeshStandardMaterial({ color: 0xFFFFFF }),
            new THREE.MeshStandardMaterial({ color: 0xFFFFFF }),
            new THREE.MeshStandardMaterial({ color: 0xFFFFFF })
        ];
        const dice = new THREE.Mesh(diceGeometry, diceMaterials);
        dice.position.set(15, 5, 15);
        scene.add(dice);

        let currentSquare = 0;

        function rollDice() {
            return Math.floor(Math.random() * 6) + 1;
        }

        // ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿
        const quizzes = [
            {
                question: "äº”æˆ¸ç”ºã®åç”£å“ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿ",
                options: ["ã‚Šã‚“ã”", "ã«ã‚“ã«ã", "ã•ãã‚‰ã‚“"],
                correctAnswer: 1
            },
            {
                question: "äº”æˆ¸ç”ºã«ã‚ã‚‹æœ‰åãªæ¸©æ³‰ã®åå‰ã¯ï¼Ÿ",
                options: ["æµ…æ°´æ¸©æ³‰", "äº”æˆ¸æ¸©æ³‰", "å€‰çŸ³æ¸©æ³‰"],
                correctAnswer: 0
            },
            // ä»–ã®ã‚¯ã‚¤ã‚ºã‚’è¿½åŠ ...
        ];

        let currentQuiz;

        function showQuiz() {
            currentQuiz = Math.floor(Math.random() * quizzes.length);
            const quiz = quizzes[currentQuiz];
            const infoPanel = document.getElementById('infoPanel');
            infoPanel.innerHTML = `
                <h3>${quiz.question}</h3>
                ${quiz.options.map((option, index) => `
                    <button onclick="answerQuiz(${index})">${option}</button>
                `).join('')}
            `;
            infoPanel.style.display = 'block';
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§é–¢æ•°ã‚’å®šç¾©
        window.answerQuiz = function(selectedAnswer) {
            const quiz = quizzes[currentQuiz];
            const infoPanel = document.getElementById('infoPanel');
            if (selectedAnswer === quiz.correctAnswer) {
                infoPanel.innerHTML = "<p>æ­£è§£ã§ã™ï¼é€²è¡Œã‚’ç¶šã‘ã¾ã™ã€‚</p>";
                setTimeout(() => {
                    infoPanel.style.display = 'none';
                }, 2000);
            } else {
                infoPanel.innerHTML = "<p>ä¸æ­£è§£ã§ã™ã€‚ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã€‚</p>";
                setTimeout(() => {
                    location.reload(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                }, 2000);
            }
        };

        function moveCharacter(steps) {
            switchToRunningModel();

            // è¶³éŸ³åŠ¹æœéŸ³ã‚’å†ç”Ÿï¼ˆBGMãŒã‚ªãƒ³ã®å ´åˆã®ã¿ï¼‰
            if (!bgm.paused) {
                footstepSound.play();
            }

            currentSquare += steps;
            if (currentSquare >= squares.length) {
                currentSquare = squares.length - 1;
            }
            const targetPosition = squares[currentSquare].position.clone();
            targetPosition.y = 0.5;
            
            const duration = 1500 * steps;
            const startPosition = character.position.clone();
            const startTime = Date.now();

            function animateMove() {
                const currentTime = Date.now();
                const elapsedTime = currentTime - startTime;
                const progress = Math.min(elapsedTime / duration, 1);

                character.position.lerpVectors(startPosition, targetPosition, progress);

                const direction = new THREE.Vector3().subVectors(targetPosition, startPosition).normalize();
                character.lookAt(character.position.clone().add(direction));

                camera.position.copy(character.position).add(new THREE.Vector3(0, 2, 5));
                camera.lookAt(character.position);

                if (progress < 1) {
                    requestAnimationFrame(animateMove);
                } else {
                    switchToWaitingModel();
                    // ç§»å‹•ãŒçµ‚ã‚ã£ãŸã‚‰è¶³éŸ³ã‚’åœæ­¢
                    footstepSound.pause();
                    footstepSound.currentTime = 0;
                    showQuiz();
                }
            }

            animateMove();
        }

        function switchToRunningModel() {
            if (character === waitingModel) {
                waitingModel.visible = false;
                runningModel.position.copy(waitingModel.position);
                runningModel.rotation.copy(waitingModel.rotation);
                runningModel.visible = true;
                character = runningModel;
                waitingAction.stop();
                runningAction.play();
            }
        }

        function switchToWaitingModel() {
            if (character === runningModel) {
                runningModel.visible = false;
                waitingModel.position.copy(runningModel.position);
                waitingModel.rotation.copy(runningModel.rotation);
                waitingModel.visible = true;
                character = waitingModel;
                runningAction.stop();
                waitingAction.play();
            }
        }

        document.getElementById('diceButton').addEventListener('click', () => {
            const result = rollDice();
            const infoPanel = document.getElementById('infoPanel');
            infoPanel.textContent = `ã‚µã‚¤ã‚³ãƒ­ã®ç›®: ${result}`;
            infoPanel.style.display = 'block';

            // ã‚µã‚¤ã‚³ãƒ­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            dice.rotation.set(
                Math.random() * Math.PI,
                Math.random() * Math.PI,
                Math.random() * Math.PI
            );

            // 1ç§’å¾Œã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ç§»å‹•
            setTimeout(() => {
                moveCharacter(result);
            }, 1000);
        });

        function animate() {
            requestAnimationFrame(animate);

            const deltaTime = clock.getDelta();
            if (waitingMixer) waitingMixer.update(deltaTime);
            if (runningMixer) runningMixer.update(deltaTime);

            // ã‚«ãƒ¡ãƒ©ã®ä½ç½®ã‚’å¸¸ã«æ›´æ–°
            if (character) {
                camera.position.copy(character.position).add(new THREE.Vector3(0, 2, 5));
                camera.lookAt(character.position);
            }

            renderer.render(scene, camera);
        }

        const clock = new THREE.Clock();
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // BGMç”¨ã®Audioè¦ç´ ã‚’ä½œæˆ
        const bgm = new Audio('ã†ã¾å†’é™º.mp3');
        bgm.loop = true; // ãƒ«ãƒ¼ãƒ—å†ç”Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹

        // è¶³éŸ³åŠ¹æœéŸ³ç”¨ã®Audioè¦ç´ ã‚’ä½œæˆ
        const footstepSound = new Audio('è¶³éŸ³.mp3');
        footstepSound.loop = true;
        footstepSound.volume = 1.0; // éŸ³é‡ã‚’æœ€å¤§ã«è¨­å®š

        let isBgmOn = true;
        let isSfxOn = true;

        function toggleBgm() {
            const bgmButton = document.getElementById('bgmButton');
            if (isBgmOn) {
                bgm.pause();
                bgmButton.textContent = 'ğŸ”‡ BGMã‚ªãƒ•';
                isBgmOn = false;
            } else {
                bgm.play();
                bgmButton.textContent = 'ğŸµ BGMã‚ªãƒ³';
                isBgmOn = true;
            }
        }

        function toggleSfx() {
            const sfxButton = document.getElementById('sfxButton');
            if (isSfxOn) {
                footstepSound.pause();
                sfxButton.textContent = 'ğŸ”‡ åŠ¹æœéŸ³ã‚ªãƒ•';
                isSfxOn = false;
            } else {
                sfxButton.textContent = 'ğŸ”Š åŠ¹æœéŸ³ã‚ªãƒ³';
                isSfxOn = true;
            }
        }

        document.getElementById('bgmButton').addEventListener('click', toggleBgm);
        document.getElementById('sfxButton').addEventListener('click', toggleSfx);

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«BGMã‚’å†ç”Ÿé–‹å§‹
        window.addEventListener('load', () => {
            bgm.play().catch(error => {
                console.log('è‡ªå‹•å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ:', error);
                document.getElementById('bgmButton').textContent = 'ğŸ”‡ BGMã‚ªãƒ•';
                isBgmOn = false;
            });
        });
    </script>
</body>
</html>
